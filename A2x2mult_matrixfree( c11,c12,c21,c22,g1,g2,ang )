function [ res ] = A2x2mult_matrixfree( c11,c12,c21,c22,g1,g2,ang )
%function [ res ] = A2x2mult_matrixfree( c11,c12,c21,c22,g1,g2,ang )
% This function calculates operation with radon function, which corresponds 
% multiplication A*g for system with two images and two materials.
%
% Version 1.0, September 13, 2019
% (c) Salla Latva-Äijö and Samuli Siltanen 
%
% Routine for the two-energies and two materials scheme related to S Siltanen's 
% method for solution of the conjugate gradient Tikhonov algorithm.
% Computes corresponding calculation A*g but without matrix A.
% 
% Arguments
% c11       attenuation coefficient for material one imaged with energy E1(low)
% c12       attenuation coefficient for material two imaged with energy E1(low)
% c21       attenuation coefficient for material one imaged with energy E2(high)
% c22       attenuation coefficient for material two imaged with energy E2(high)
% g1        reconstruction image of target 1
% g2        reconstruction image of target 2
% Returns
% res       sinograms of g1 and g2, (=m1 and m2), as images one after onother (size x*40) 
%
% Last revision Salla Latva-Äijö Sep 2019

% This function calculates multiplication A*g for system with two images
% and two materials, without constructing the matrix A.

% Perform the needed matrix multiplications. Now a matrix multiplication
% has been switched to radon
ag1 = radon(g1,ang);
ag2 = radon(g2,ang);

% Calculate the parts needed for block matrix multiplication
res1 = c11*ag1;
res2 = c12*ag2;
res3 = c21*ag1;
res4 = c21*ag2;

% Combine results into the result
res = [res1 + res2; res3 + res4];
end




function [ res ] = radon2x2mult(c11,c12,c21,c22,g1,g2,measang)
% A*g
Ag1 = c11*radon(g1,measang)+...
    c12*radon(g2,measang);
Ag2 = c21*radon(g1,measang)+...
    c22*radon(g2,measang);
% ATAg
% ATAg = [iradon(Ag1,measang,'none')*c11+...
%     iradon(Ag2,measang,'none')*c21; ...
%     iradon(Ag1,measang,'none')*c12+ ...
%     iradon(Ag2,measang,'none')*c22];

% Tuleeko virhe yllä, jos ei heti leikkaa 
% ylimääräisiä rivejä ja käytä crxn termiä?
% Kokeillaan!
ATAg_eka = iradon(Ag1,measang,'none');
ATAg_eka = ATAg_eka(2:end-1,2:end-1);
corxn = 7.65; % Incomprehensible correction factor
ATAg_eka     = corxn*ATAg_eka;
 
ATAg_toka = iradon(Ag2,measang,'none');
ATAg_toka = ATAg_toka(2:end-1,2:end-1);
ATAg_toka     = corxn*ATAg_toka;
 
ATAg_kolmas = iradon(Ag1,measang,'none');
ATAg_kolmas = ATAg_kolmas(2:end-1,2:end-1);
ATAg_kolmas     = corxn*ATAg_kolmas;
 
ATAg_neljas = iradon(Ag2,measang,'none');
ATAg_neljas = ATAg_neljas(2:end-1,2:end-1);
ATAg_neljas     = corxn*ATAg_neljas;
 
ATAg = [ATAg_eka*c11+...
ATAg_toka*c21; ...
ATAg_kolmas*c12+ ...
ATAg_neljas*c22];
res = ATAg;
end
